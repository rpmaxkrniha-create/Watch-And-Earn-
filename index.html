<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Earn Stars - Testing</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://adsgram.ai/sdk/v1/adsgram.js"></script>
    <style>
        :root {
            --bg: var(--tg-theme-bg-color, #ffffff);
            --text: var(--tg-theme-text-color, #000000);
            --hint: var(--tg-theme-hint-color, #999999);
            --button: var(--tg-theme-button-color, #2481cc);
            --button-text: var(--tg-theme-button-text-color, #ffffff);
            --secondary: var(--tg-theme-secondary-bg-color, #f4f4f5);
        }
        body { font-family: sans-serif; background-color: var(--bg); color: var(--text); padding: 20px; text-align: center; }
        .card { background: var(--secondary); border-radius: 15px; padding: 20px; margin-top: 20px; }
        .balance { font-size: 32px; font-weight: bold; margin: 10px 0; }
        button { background-color: var(--button); color: var(--button-text); border: none; border-radius: 10px; padding: 15px; width: 100%; font-size: 18px; font-weight: bold; cursor: pointer; }
        button:disabled { opacity: 0.5; }
        #status { font-size: 14px; margin-top: 10px; color: var(--hint); }
    </style>
</head>
<body>

    <h2>Welcome, <span id="user-name">User</span></h2>
    
    <div class="card">
        <div>Your Points</div>
        <div class="balance"><span id="balance">0</span> âœ¨</div>
        <button id="ad-btn" onclick="showAd()">Watch Video</button>
        <div id="status">Checking status...</div>
        <div id="limit-info" style="font-size: 12px; margin-top: 5px; color: var(--hint);"></div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();

        // CONFIGURATION
        const AD_LIMIT = 30; 
        const COOLDOWN_MS = 8000; // 8 Seconds
        const AD_BLOCK_ID = "YOUR_ADSGRAM_BLOCK_ID"; // Replace with real ID or '2714' for testing

        const AdController = window.Adsgram.init({ blockId: AD_BLOCK_ID });

        // LOAD SAVED DATA
        let balance = parseInt(localStorage.getItem('balance')) || 0;
        let lastWatch = parseInt(localStorage.getItem('lastWatch')) || 0;
        let dailyCount = parseInt(localStorage.getItem('dailyCount')) || 0;
        let lastDate = localStorage.getItem('lastDate') || new Date().toDateString();

        // RESET DAILY LIMIT IF NEW DAY
        if (lastDate !== new Date().toDateString()) {
            dailyCount = 0;
            lastDate = new Date().toDateString();
            localStorage.setItem('lastDate', lastDate);
            localStorage.setItem('dailyCount', 0);
        }

        document.getElementById('user-name').innerText = tg.initDataUnsafe?.user?.first_name || "Guest";
        document.getElementById('balance').innerText = balance;

        function updateUI() {
            const now = Date.now();
            const btn = document.getElementById('ad-btn');
            const status = document.getElementById('status');
            const limitInfo = document.getElementById('limit-info');

            limitInfo.innerText = `Daily Limit: ${dailyCount}/${AD_LIMIT}`;

            if (dailyCount >= AD_LIMIT) {
                btn.disabled = true;
                status.innerText = "Daily limit reached! Come back tomorrow.";
                return;
            }

            const timePassed = now - lastWatch;
            if (timePassed < COOLDOWN_MS) {
                btn.disabled = true;
                const remaining = Math.ceil((COOLDOWN_MS - timePassed) / 1000);
                status.innerText = `Cooldown: ${remaining}s`;
                setTimeout(updateUI, 1000);
            } else {
                btn.disabled = false;
                status.innerText = "Ready to earn!";
            }
        }

        async function showAd() {
            try {
                tg.HapticFeedback.impactOccurred('light');
                
                // Show Ad
                await AdController.show();
                
                // On Success
                balance += 10;
                dailyCount += 1;
                lastWatch = Date.now();

                // Save to Storage
                localStorage.setItem('balance', balance);
                localStorage.setItem('dailyCount', dailyCount);
                localStorage.setItem('lastWatch', lastWatch);

                document.getElementById('balance').innerText = balance;
                tg.HapticFeedback.notificationOccurred('success');
                updateUI();
                
            } catch (e) {
                tg.showAlert("Ad failed to load. Please try again later.");
            }
        }

        updateUI();
    </script>
</body>
</html>
